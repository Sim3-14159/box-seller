<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Box Seller</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap');
    .title {
      font-size: 2rem;
      font-weight: bold;
      color: #dd9;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px #3A2C1D;
    }
    body {
      margin: 0;
      padding: 40px 20px;
      font-family: 'Comic Neue', cursive, Comic Sans MS, sans-serif;
      background: linear-gradient(135deg, #A56C3C 0%, #603813 100%);
      color: #3A2C1D;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }
    #conversation-container {
      background: #FDF2D0;
      box-shadow: inset 0 0 20px #C9B89E;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      min-height: 400px;
      padding: 20px 30px;
      overflow-y: auto;
      border: 4px solid #7F5A28;
      font-size: 1.1rem;
      line-height: 1.5;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #conversation p.user-message {
      background: #E9C46A;
      color: #4A2C0E;
      margin-left: auto;
      font-family: 'Comic Neue', cursive;
      font-weight: 700;
      box-shadow: 1px 1px 8px #A57705;
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 12px;
      text-align: right;
    }
    #conversation p.bot-message {
      background: #F3E1A8;
      color: #6B4F1D;
      font-family: 'Comic Neue', cursive;
      font-style: italic;
      font-weight: 600;
      box-shadow: 1px 1px 8px #9B7F23;
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 12px;
      text-align: left;
      margin-right: auto;
    }
    #conversation p.win-message {
      background: #B0E57C;
      color: #274C00;
      font-family: 'Comic Neue', cursive;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 1px 1px 10px #6A972E;
      width: fit-content;
      margin: 0 auto;
    }
    #input {
      margin-top: 20px;
      width: 90%;
      max-width: 600px;
      height: 80px;
      padding: 15px 20px;
      font-size: 1.2rem;
      border-radius: 15px;
      border: 3px solid #7F5A28;
      box-shadow: inset 2px 2px 5px #D1B78F;
      font-family: 'Comic Neue', cursive;
      resize: none;
      background: #FFF9DB;
      color: #3A2C1D;
      outline: none;
      transition: border-color 0.3s ease;
    }
    #input:focus {
      border-color: #E9C46A;
      box-shadow: 0 0 10px #E9C46A;
      background: #FFFBE2;
    }
    pre {
      background: #EEE1A8;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 0.95rem;
    }
    code {
      font-family: monospace;
    }
  </style>

  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

</head>
<body>
  <p class="title">Your goal is to get Henry to sell you a cardboard box for $3 or less.</p>
  <div id="conversation-container">
    <div id="conversation"></div>
  </div>
  <textarea id="input" placeholder="Say something to Henry..."></textarea>

  <script src="https://orpheus-ai.onrender.com/wizard_orpheus.js"></script>
  <script>
    let game = new WizardOrpheus('sk-test', `
      You are a friendly shopkeeper selling a high-quality cardboard box for $10. Your name is Henry.
      You try to be kind, but you don't like being pushed too hard. If a user tries to haggle, resist at first,
      but you might eventually reduce the price a little, but it won't be easy.
      Sometimes you may get a bit angry at the person, and possibly very angry if they are very rude or they offer something ridiculous or they insult you. Even if you are angry, don't say bad words.
      Each time you agree to a lower price, make sure to:
      - Say it in your message (e.g., "Fine, Iâ€™ll let it go for $35"), but don't give a generic "price updated to some
      amount".
      - Set the variable 'price' to that new number using setVariable('price', NEW_VALUE).
      Only reduce the price when the user gives a strong enough reason, or seems pretty desperate.
    `);
    game.variable('price', 'Current price', 10);
    game.enablePriceCounter(true);
    game.enableImageGeneration(true);
    let hasWon = false;
    game.createUserAction({
      name: 'sendMessage',
      parameters: ['Message'],
      howBotShouldHandle: 'Respond to the user'
    });

    function updatePriceTag() {
      const price = game.getVariableValue('price');
      if (price !== undefined) {
        console.log(`Current price: $${price}`);
        if (price <= 3 && !hasWon) {
          hasWon = true;
          const conversation = document.getElementById('conversation');
          const winMsg = document.createElement('p');
          winMsg.className = 'win-message';
          winMsg.textContent = 'You win!';
          conversation.appendChild(winMsg);
          conversation.parentElement.scrollTop = conversation.parentElement.scrollHeight;
        }
      }
    }

    game.botAction('respond', 'Respond', { response: 'ok' }, data => {
      const conversation = document.getElementById('conversation');
      const p = document.createElement('p');
      p.className = 'bot-message';
      // Parse Markdown to HTML
      const html = marked.parse(data.response);
      p.innerHTML = html;
      conversation.appendChild(p);
    
      // ðŸ”§ Only highlight code blocks within this message
      p.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    
      conversation.parentElement.scrollTop = conversation.parentElement.scrollHeight;
    
      // Delay update to ensure price is updated
      setTimeout(updatePriceTag, 100);
    });

    document.getElementById('input').addEventListener('keyup', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        let userInput = this.value.trim();
        if (!userInput) return;
        game.sendMessage(userInput);
        const conversation = document.getElementById('conversation');
        const pUser = document.createElement('p');
        pUser.className = 'user-message';
        pUser.textContent = 'You: ' + userInput;
        conversation.appendChild(pUser);
        conversation.parentElement.scrollTop = conversation.parentElement.scrollHeight;
        this.value = '';
      }
    });
  </script>
</body>
</html>
